{% extends "base.html" %}
{% block content %}
<div class="card" style="max-width: 880px; margin: 0 auto;">
  <p style="margin:0 0 .75rem;">
    <strong>E-mail:</strong> {{ email }} &middot; <strong>Papel:</strong> {{ papel }}
  </p>

  <div style="margin:0.5rem 0 1.25rem; line-height:1.5;">
    <strong>Feedback:</strong>
    <div style="white-space:pre-wrap; border:1px solid #e5e7eb; border-radius:.5rem; padding:.75rem; background:#fafafa;">
      {{ item["Feedback"] }}
    </div>
  </div>

  <form method="post" action="/submit" id="form-avaliar" style="display:block;">
    <input type="hidden" name="email" value="{{ email }}" />
    <input type="hidden" name="id" value="{{ item.id }}" />
    <input type="hidden" name="papel" value="{{ papel }}" />

    <!-- Pergunta principal -->
    <label style="display:block; font-weight:600; margin:.25rem 0 .5rem;">
      Para você esse Feedback é bom e faz sentido?
    </label>
    <div style="margin: .25rem 0 1rem;">
      <label><input type="radio" name="resposta" value="Sim" required {% if not item.get('Resposta_avaliador_1') and not item.get('Resposta_avaliador_2') %}checked{% endif %}> Sim</label>
      <label style="margin-left:1rem;"><input type="radio" name="resposta" value="Não" required> Não</label>
    </div>

    <!-- Picklist de problemas -->
    <label style="display:block; font-weight:600; margin:.25rem 0 .5rem;">
      Quais problemas você identifica?
    </label>
    <div style="margin:.25rem 0 1rem;">
      {% for opc in opcoes %}
        <label style="display:block; margin:.25rem 0;">
          <input
            type="checkbox"
            name="problemas"
            value="{{ opc }}"
            {% if papel == 'Avaliador_1' %}
              {% if item.get('Problemas_avaliador_1') and (opc in (item['Problemas_avaliador_1'] or '')) %}checked{% endif %}
            {% elif papel == 'Avaliador_2' %}
              {% if item.get('Problemas_avaliador_2') and (opc in (item['Problemas_avaliador_2'] or '')) %}checked{% endif %}
            {% endif %}
          >
          {{ opc }}
        </label>
      {% endfor %}
      <!-- Indicador para permitir "limpar" problemas quando nenhum checkbox for marcado -->
      <input type="hidden" name="problemas_submitted" value="1">
    </div>

    <!-- Campo aberto (nova pergunta) -->
    <label for="campo_aberto" style="display:block; font-weight:600; margin:.25rem 0 .5rem;">
      Caso tenha alguma consideração, escreva abaixo
    </label>
    <textarea
      id="campo_aberto"
      name="campo_aberto"
      rows="4"
      style="width:100%; margin:.25rem 0 1rem; padding:.6rem .75rem; border:1px solid #e5e7eb; border-radius:.5rem; resize:vertical;"
      placeholder="Escreva aqui suas observações (opcional)">{% if papel == 'Avaliador_2' %}{{ item.get('campo_aberto_2') or '' }}{% else %}{{ item.get('campo_aberto') or '' }}{% endif %}</textarea>

    <div style="display:flex; gap:.75rem; align-items:center;">
      <button class="btn" type="submit" style="padding:.6rem 1rem; border:0; border-radius:.5rem; background:#111827; color:white; cursor:pointer;">
        Enviar e ir para o próximo
      </button>
      <a href="/fim?email={{ email }}" style="text-decoration:none; color:#6b7280;">pular por agora</a>
    </div>
  </form>
</div>
{% endblock %}
